
# ë¡œê·¸ì¸ ì²˜ë¦¬2(í•„í„°, ì¸í„°ì…‰í„°) - ì„œë¸”ë¦¿ í•„í„°(ì¸ì¦ì²´í¬)

ë¡œê·¸ì¸ ë˜ì§€ ì•Šì€ ì‚¬ìš©ìëŠ” ìƒí’ˆ ê´€ë¦¬ ë¿ë§Œ ì•„ë‹ˆë¼ ë¯¸ë˜ì— ê°œë°œë  í˜ì´ì§€ì—ë„ ì ‘ê·¼í•˜ì§€ ëª»í•˜ë„ë¡ í•˜ì.

### LoginCheckFilter - ì¸ì¦ ì²´í¬ í•„í„°

```java
@Slf4j
public class LoginCheckFilter implements Filter {

    private static final String[] whiteList =
            {"/", "/members/add", "/login", "/logout", "/css/*"};

    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        log.info("LoginCheckFilter.init");
    }

    @Override
    public void destroy() {
        log.info("LoginCheckFilter.destroy");
    }

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
        log.info("LoginCheckFilter.doFilter");

        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;

        String requestURI = httpRequest.getRequestURI();

        try {
            log.info("ì¸ì¦ ì²´í¬ í•„í„° ì‹œì‘{}", requestURI);

            if(isLoginCheckPath(requestURI)){
                log.info("ì¸ì¦ ì²´í¬ ë¡œì§ ì‹¤í–‰{}", requestURI);
                HttpSession session = httpRequest.getSession(false);
                if(session == null || session.getAttribute(SessionConst.LOGIN_MEMBER) == null){

                    log.info("ë¯¸ì¸ì¦ ì‚¬ìš©ì ìš”ì²­{}", requestURI);
                    // ë¡œê·¸ì¸ìœ¼ë¡œ redirect
                    httpResponse.sendRedirect("/login?redirectURL=" + requestURI);
                    return;
                }

            }
            chain.doFilter(request, response);
        }
        catch (Exception e){
            throw e;
        }
        finally {
            log.info("ì¸ì¦ ì²´í¬ í•„í„° ì¢…ë£Œ{}", requestURI);
        }

    }
    /**
     * í™”ì´íŠ¸ ë¦¬ìŠ¤íŠ¸ì˜ ê²½ìš° ì¸ì¦ ì²´í¬X
     */
    private boolean isLoginCheckPath(String requestURI){
        return !PatternMatchUtils.simpleMatch(whiteList, requestURI);
    }
}
```
- ```whitelist = {"/", "/members/add", "/login", "/logout","/css/*"};```
  - ì¸ì¦ í•„í„°ë¥¼ ì ìš©í•´ë„ í™ˆ, íšŒì›ê°€ì…, ë¡œê·¸ì¸ í™”ë©´, css ê°™ì€ ë¦¬ì†ŒìŠ¤ì—ëŠ” ì ‘ê·¼í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.
  - ì´ë ‡ê²Œ í™”ì´íŠ¸ ë¦¬ìŠ¤íŠ¸ ê²½ë¡œëŠ” ì¸ì¦ê³¼ ë¬´ê´€í•˜ê²Œ í•­ìƒ í—ˆìš©í•œë‹¤.
  - í™”ì´íŠ¸ ë¦¬ìŠ¤íŠ¸ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ëª¨ë“  ê²½ë¡œì—ëŠ” ì¸ì¦ ì²´í¬ ë¡œì§ì„ ì ìš©í•œë‹¤.
- ```isLoginCheckPath(requestURI)```
  - ```!PatternMatchUtils.simpleMatch(whiteList, requestURI);```
  - í™”ì´íŠ¸ ë¦¬ìŠ¤íŠ¸ë¥¼ ì œì™¸í•œ ëª¨ë“  ê²½ìš°ì— ì¸ì¦ ì²´í¬ ë¡œì§ì„ ì ìš©í•œë‹¤.
- ```httpResponse.sendRedirect("/login?redirectURL=" + requestURI);```
  - ë¯¸ì¸ì¦ ì‚¬ìš©ìëŠ” ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•œë‹¤. 
  - ë¡œê·¸ì¸ ì´í›„ì— ë‹¤ì‹œ í™ˆìœ¼ë¡œ ì´ë™í•´ë²„ë¦¬ë©´, ì›í•˜ëŠ” ê²½ë¡œë¥¼ ë‹¤ì‹œ ì°¾ì•„ê°€ì•¼ í•˜ëŠ” ë¶ˆí¸í•¨ì´ ìˆë‹¤.
  - ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´ ì²˜ìŒ ìš”ì²­í–ˆë˜ í˜ì´ì§€ë¥¼ ë³´ì—¬ì£¼ì.
  - â¡ï¸ requestURI /login ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬
  - í•´ë‹¹ ê²½ë¡œë¡œ ì´ë™í•˜ëŠ” ê¸°ëŠ¥ì€ ì¶”ê°€ë¡œ ê°œë°œí•´ì•¼ í•œë‹¤. 
- ```return;```
  - í•„í„°ë¥¼ ë”ëŠ” ì§„í–‰í•˜ì§€ ì•ŠëŠ”ë‹¤. ì´í›„ í•„í„°ëŠ” ë¬¼ë¡  ì„œë¸”ë¦¿, ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ë”ëŠ” í˜¸ì¶œë˜ì§€ ì•ŠëŠ”ë‹¤.
  - ì•ì„œ redirect ë¥¼ ì‚¬ìš©í–ˆê¸° ë•Œë¬¸ì— redirect ê°€ ì‘ë‹µìœ¼ë¡œ ì ìš©ë˜ê³  ìš”ì²­ì´ ëë‚œë‹¤.

### WebConfig - loginCheckFilter() ì¶”ê°€

```java
@Configuration
public class WebConfig {
    @Bean
    public FilterRegistrationBean<Filter> logFilter(){
        FilterRegistrationBean<Filter> filterRegistrationBean = new FilterRegistrationBean<>();
        filterRegistrationBean.setFilter(new LogFilter());
        filterRegistrationBean.setOrder(1);
        filterRegistrationBean.addUrlPatterns("/*");

        return filterRegistrationBean;
    }
    @Bean
    public FilterRegistrationBean<Filter> loginCheckFilter(){
        FilterRegistrationBean<Filter> filterRegistrationBean = new FilterRegistrationBean<>();
        filterRegistrationBean.setFilter(new LoginCheckFilter());
        filterRegistrationBean.setOrder(2);
        filterRegistrationBean.addUrlPatterns("/*");

        return filterRegistrationBean;
    }
}
```
- setFilter(new LoginCheckFilter()) : ë¡œê·¸ì¸ í•„í„°ë¥¼ ë“±ë¡í•œë‹¤.
- setOrder(2) : ìˆœì„œë¥¼ 2ë²ˆìœ¼ë¡œ ì¡ì•˜ë‹¤. ë¡œê·¸ í•„í„° ë‹¤ìŒì— ë¡œê·¸ì¸ í•„í„°ê°€ ì ìš©ëœë‹¤.
- addUrlPatterns("/*") : ëª¨ë“  ìš”ì²­ì— ë¡œê·¸ì¸ í•„í„°ë¥¼ ì ìš©í•œë‹¤. 

### RedirectURL ì²˜ë¦¬

- ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´ ì²˜ìŒ ìš”ì²­í•œ URLë¡œ ì´ë™í•˜ëŠ” ê¸°ëŠ¥ì„ ê°œë°œí•´ë³´ì.
- LoginController - loginV4()

```java
    /**
     * ì¸ì¦ì´ í•„ìš”í•œ í˜ì´ì§€ì— ì¸ì¦ ì—†ì´ ìš”ì²­í–ˆë‹¤ê°€ ë¦¬ë‹¤ì´ë ‰íŠ¸ ëœ ê²½ìš°
     * ë¡œê·¸ì¸ ì„±ê³µ -> ì²˜ìŒ ìš”ì²­ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
     */
   @PostMapping("/login")
   public String loginV4(@Validated @ModelAttribute LoginForm form,
                         BindingResult bindingResult,
                         HttpServletRequest request,
                         @RequestParam(defaultValue = "/") String redirectURL){

       if(bindingResult.hasErrors()){
           return "login/loginForm";
       }

       Member loginMember = loginService.login(form.getLoginId(), form.getPassword());

       if(loginMember == null){
           bindingResult.reject("loginFail", "ì•„ì•„ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.");
           return "login/loginForm";
       }

       // ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬
       // ì„¸ì…˜ì´ ìˆìœ¼ë©´ ìˆëŠ” ì„¸ì…˜ ë°˜í™˜, ì—†ìœ¼ë©´ ì‹ ê·œ ì„¸ì…˜ ë°˜í™˜
       // .getSession(boolean) default : true -> ìƒëµ ê°€ëŠ¥
       HttpSession session = request.getSession(true);
       // ì„¸ì…˜ì— ë¡œê·¸ì¸ íšŒì› ì •ë³´ ë³´ê´€
       session.setAttribute(SessionConst.LOGIN_MEMBER, loginMember);

       return "redirect:" + redirectURL;
   }
```

- ë¡œê·¸ì¸ ì²´í¬ í•„í„°ì—ì„œ, ë¯¸ì¸ì¦ ì‚¬ìš©ìëŠ” ìš”ì²­ ê²½ë¡œë¥¼ í¬í•¨í•´ì„œ /login ì— redirectURL 
  ìš”ì²­ íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•´ì„œ ìš”ì²­í–ˆë‹¤.
- ì´ ê°’ì„ ì‚¬ìš©í•´ì„œ ë¡œê·¸ì¸ ì„±ê³µì‹œ í•´ë‹¹ ê²½ë¡œë¡œ ê³ ê°ì„ redirect í•œë‹¤.

ğŸ’¯ì •ë¦¬
- ì„œë¸”ë¦¿ í•„í„°ë¥¼ ì˜ ì‚¬ìš©í•œ ë•ë¶„ì— ë¡œê·¸ì¸ í•˜ì§€ ì•Šì€ ì‚¬ìš©ìëŠ” ë‚˜ë¨¸ì§€ ê²½ë¡œì— ë“¤ì–´ê°ˆ ìˆ˜ ì—†ê²Œ ë˜ì—ˆë‹¤.
- ê³µí†µ ê´€ì‹¬ì‚¬ë¥¼ ì„œë¸”ë¦¿ í•„í„°ë¥¼ ì‚¬ìš©í•´ì„œ í•´ê²°í•œ ë•ë¶„ì— í–¥í›„ ë¡œê·¸ì¸ ê´€ë ¨ ì •ì±…ì´ ë³€ê²½ë˜ì–´ë„ ì´ ë¶€ë¶„ë§Œ ë³€ê²½í•˜ë©´ ëœë‹¤.
- ë‹¨ì¼ ì±…ì„ ì›ì¹™ 

âœ…ì°¸ê³ 
```text
í•„í„°ì—ëŠ” ìŠ¤í”„ë§ ì¸í„°ì…‰í„°ì—ì„œ ì œê³µí•˜ì§€ ì•ŠëŠ” ê°•ë ¥í•œ ê¸°ëŠ¥ì´ ìˆë‹¤.
chain.doFilter(request, response); í˜¸ì¶œí•´ì„œ ë‹¤ìŒ í•„í„° ë˜ëŠ” ì„œë¸”ë¦¿ì„ í˜¸ì¶œí•  ë•Œ 
request, response ë¥¼ ë‹¤ë¥¸ ê°ì²´ë¡œ ë°”ê¿€ ìˆ˜ ìˆë‹¤.

ServletRequest , ServletResponse ë¥¼ êµ¬í˜„í•œ ë‹¤ë¥¸ ê°ì²´ë¥¼ ë§Œë“¤ì–´ì„œ ë„˜ê¸°ë©´ 
í•´ë‹¹ ê°ì²´ê°€ ë‹¤ìŒ í•„í„° ë˜ëŠ” ì„œë¸”ë¦¿ì—ì„œ ì‚¬ìš©ëœë‹¤. ì˜ ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥ì€ ì•„ë‹ˆë‹ˆ ì°¸ê³ ë§Œ í•´ë‘ì.
```
