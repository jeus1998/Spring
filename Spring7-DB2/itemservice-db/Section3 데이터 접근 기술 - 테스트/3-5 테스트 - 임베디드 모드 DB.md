# 테스트 - 임베디드 모드 DB

```text
테스트 케이스를 실행하기 위해서 별도의 데이터베이스를 설치하고, 운영하는 것은 상당히 번잡한 작업이다.
단순히 테스트를 검증할 용도로만 사용하기 때문에 테스트가 끝나면 데이터베이스의 데이터를 모두 삭제해도 된다. 
더 나아가서 테스트가 끝나면 데이터베이스 자체를 제거해도 된다.
```
### 임베디드 모드 

임베디드 모드 
```text
H2 데이터베이스는 자바로 개발되어 있고, JVM안에서 메모리 모드로 동작하는 특별한 기능을 제공한다.
그래서 애플리케이션을 실행할 때 H2 데이터베이스도 해당 JVM 메모리에 포함해서 함께 실행할 수 있다.
DB를 애플리케이션에 내장해서 함께 실행한다고 해서 임베디드 모드(Embedded mode)라 한다.
물론 애플리케이션이 종료되면 임베디드 모드로 동작하는 H2 데이터베이스도 함께 종료되고, 데이터도 모두 사라진다.
애플리케이션에서 자바 메모리를 함께 사용하는 라이브러리처럼 동작하는 것이다.
```

ItemServiceApplication - 추가
```java
@Bean
@Profile("test")
public DataSource dataSource(){
     log.info("메모리 데이터베이스 초기화");
     DriverManagerDataSource dataSource = new DriverManagerDataSource();
     dataSource.setDriverClassName("org.h2.driver");
     dataSource.setUrl("jdbc:h2:mem:db;DB_CLOSE_DELAY=-1");
     dataSource.setUsername("sa");
     dataSource.setPassword("");
     return dataSource;
}
```
- ``@Profile("test")``
  - 프로필이 test 인 경우에만 데이터소스를 스프링 빈으로 등록한다.
  - 테스트 케이스에서만 이 데이터소스를 스프링 빈으로 등록해서 사용하겠다는 뜻이다.
- ``dataSource()``
  - ``jdbc:h2:mem:db``이 부분이 중요하다. 데이터소스를 만들때 이렇게만 적으면 임베디드 모드(메모리 모드)로 
    동작하는 H2 데이터베이스를 사용할 수 있다.
  - ``DB_CLOSE_DELAY=-1`` 임베디드 모드에서는 데이터베이스 커넥션 연결이 모두 끊어지면 데이터베이스도 종료되는데, 
    그것을 방지하는 설정이다
  - 이 데이터소스를 사용하면 메모리 DB를 사용할 수 있다.

실행, 실행 결과 
```text
이제 ItemRepositoryTest 테스트를 메모리 DB를 통해 실행해보자.
테스트를 실행만 하면 새로 등록한 메모리 DB에 접근하는 데이터소스를 사용하게 된다

실행 결과 
PreparedStatementCallback; bad SQL grammar []; nested exception is org.h2.jdbc.JdbcSQLSyntaxErrorException: Table "ITEM" not found; SQL statement:
INSERT INTO item () VALUES() [42102-200]

Table "ITEM" not found 이 부분이 핵심이다. 데이터베이스 테이블이 없는 것이다.
생각해보면 메모리 DB에는 아직 테이블을 만들지 않았다.

테스트를 실행하기 전에 테이블을 먼저 생성해주어야 한다. 수동으로 할 수도 있지만 스프링 부트는 이 문제를 해결할
아주 편리한 기능을 제공해준다.
```

### 스프링 부트 - 기본 SQL 스크립트를 사용해서 데이터베이스를 초기화하는 기능

- 메모리 DB는 애플리케이션이 종료될 때 함께 사라지기 때문에, 애플리케이션 실행 시점에 데이터베이스 테이블도 새로
  만들어주어야 한다.
- JDBC나 JdbcTemplate를 직접 사용해서 테이블을 생성하는 DDL을 호출해도 되지만, 너무 불편하다. 스프링 부트는
  SQL 스크립트를 실행해서 애플리케이션 로딩 시점에 데이터베이스를 초기화하는 기능을 제공한다.

src/test/resources/schema.sql
```sql
drop table if exists item CASCADE;
create table item
(
   id bigint generated by default as identity,
   item_name varchar(10),
   price integer,
   quantity integer,
   primary key (id)
);
```

참고
- SQL 스크스프링 부트 공식 메뉴얼트를 사용해서 데이터베이스를 초기화하는 자세한 방법은 다음 스프링 부트 공식 메뉴얼을 참고하자.
- [스프링 부트 공식 메뉴얼](https://docs.spring.io/spring-boot/docs/current/reference/html/howto.html#howto.datainitialization.using-basic-sql-scripts)
